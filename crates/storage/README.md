# norn-storage - 持久化存储引擎模块

## 1. 模块概述 (Overview)

**norn-storage** 是 rust-norn 区块链系统的"数据仓库"，负责将所有链上数据持久化存储到磁盘上。如果把区块链系统比作一家银行，norn-storage 就是银行的"金库和档案室"，确保所有交易记录、账户余额、区块数据都不会因为系统断电而丢失。

这个模块解决了最关键的**数据持久化**问题：内存中的数据在系统重启后会消失，而区块链要求"永不丢失"的数据存储。norn-storage 基于 SledDB 嵌入式数据库，提供了一个高性能、零配置、开箱即用的存储解决方案。

**核心业务价值**：
- 💾 **确保数据永不丢失**：所有链上数据安全存储在磁盘中
- ⚡ **高性能查询**：支持快速的数据读写，满足区块链高吞吐需求
- 🔧 **零运维成本**：嵌入式数据库，无需独立的数据库服务器
- 📦 **开箱即用**：无需复杂的安装配置，启动即用

---

## 2. 核心功能列表 (Key Features)

- **键值对存储（KV Store）**
  - 基于 SledDB 的嵌入式数据库引擎
  - 支持任意键值对的读写操作
  - 就像"超大型文件柜"，可以快速存取任意文件
  - 支持数据压缩，节省磁盘空间

- **自动数据持久化**
  - 所有写操作自动同步到磁盘
  - 支持内存缓存，加速读操作
  - 就像"自动保存"功能，无需手动触发
  - 系统崩溃时数据不丢失

- **批量写入支持**
  - 支持一次性写入大量键值对
  - 提高批量数据的写入效率
  - 就像"批量归档"，一次处理大量文件

- **数据查询接口**
  - 支持按 Key 快速查询 Value
  - 支持前缀查询（Prefix Scan），快速遍历某个前缀的所有数据
  - 就像"按姓氏查询客户档案"

- **事务支持**
  - 支持 ACID 事务，保证数据一致性
  - 多个写操作要么全部成功，要么全部失败
  - 就像"转账操作"，要么两笔账都改成功，要么都不改

---

## 3. 业务流程/使用场景 (Use Cases)

### 场景一：新区块的持久化存储

**场景描述**：共识机制达成一致，生成了一个新的区块，需要将区块数据永久保存。

**业务流程**：
1. 区块链引擎调用 norn-storage 的存储接口
2. 存储引擎将区块数据序列化后写入数据库
3. 数据自动同步到磁盘，确保持久化
4. 同时更新内存缓存，便于快速查询
5. 返回存储成功确认

**业务价值**：
- 确保区块数据不会因系统重启而丢失
- 支持快速的数据恢复和查询
- 为区块链的"不可篡改"特性提供底层支撑

### 场景二：节点重启后的数据恢复

**场景描述**：区块链节点因维护或升级需要重启，重启后需要快速恢复到之前的状态。

**业务流程**：
1. 节点启动时，norn-storage 自动加载数据库文件
2. 从数据库中读取最新的区块高度（链的最新状态）
3. 加载最新的区块头数据，恢复到内存
4. 节点继续从之前的状态开始运行

**业务价值**：
- 实现"秒级"启动恢复，无需重新同步整个链
- 保证业务连续性，减少服务中断时间
- 降低运维复杂度

### 场景三：历史数据查询

**场景描述**：用户或应用程序需要查询某个历史交易或某个高度的区块。

**业务流程**：
1. 应用程序通过 RPC 接口发起查询请求
2. 存储引擎根据区块哈希或区块高度查询数据库
3. 从磁盘读取数据并反序列化
4. 返回完整的区块或交易数据

**业务价值**：
- 支持区块链浏览器的数据展示
- 满足审计和合规性要求
- 提供完整的历史数据追溯能力

---

## 4. 部署与配置要求 (Deployment & Configuration)

### 环境要求

- **磁盘空间**：根据链的数据量决定
  - 初始要求：至少 10GB 可用空间
  - 生产环境建议：预留 500GB 或更多（取决于链上数据增长速度）
  - 数据量估算：每笔交易约 200-500 字节，每个区块约几MB

- **磁盘性能**：建议使用 SSD 固态硬盘
  - 顺序写入速度：影响区块同步速度
  - 随机读取速度：影响历史数据查询性能
  - 推荐 NVMe SSD 以获得最佳性能

- **文件系统**：支持 ext4、xfs、NTFS、FAT32 等常见文件系统

### 关键配置项

在节点配置文件中，存储相关的配置项如下：

```toml
# 数据目录配置
data_dir = "/var/lib/norn"

# 数据库会自动创建在 data_dir 下
# 生成的数据库文件包括：
# - db.sled：主数据库文件
# - 其他辅助文件
```

**配置说明**：
- `data_dir`：指定数据存储路径
  - 生产环境建议使用高性能磁盘（如 SSD）
  - 确保该目录有足够的磁盘空间
  - 确保运行节点的用户有读写权限

### 运维建议

- **定期备份**：虽然数据在链上有多份拷贝，但本地备份可以加速恢复
- **监控磁盘使用率**：设置告警阈值（如 80%），避免磁盘写满导致节点停止
- **数据清理策略**：可根据业务需求配置数据保留策略（如裁剪历史状态）
- **数据迁移**：如需更换存储位置，可停止节点后复制 `data_dir` 到新位置

---

## 5. 接口与集成说明 (API & Integration)

norn-storage 通过 Rust 的 `DBInterface` trait 提供统一的存储接口，供上层模块调用。

### 主要接口能力

1. **基础读写接口**
   ```rust
   // 写入数据
   async fn put(&self, key: &[u8], value: Vec<u8>) -> Result<()>;

   // 读取数据
   async fn get(&self, key: &[u8]) -> Result<Option<Vec<u8>>>;

   // 批量写入
   async fn put_batch(&self, items: Vec<(Vec<u8>, Vec<u8>)>) -> Result<()>;

   // 删除数据
   async fn delete(&self, key: &[u8]) -> Result<()>;
   ```

2. **集成示例**
   ```rust
   use norn_storage::SledDB;
   use norn_common::traits::DBInterface;

   // 初始化数据库
   let db = SledDB::new("/var/lib/norn").await?;

   // 存储区块
   let block_hash = block.header.block_hash.0;
   let block_data = serialize(&block)?;
   db.put(&block_hash, block_data).await?;

   // 查询区块
   if let Some(data) = db.get(&block_hash).await? {
       let block = deserialize::<Block>(&data)?;
       // 处理区块
   }
   ```

### 性能特性

- **写入性能**：SSD 环境下可达 10,000+ 写入/秒
- **读取性能**：内存缓存命中时 < 1ms，磁盘读取 < 10ms
- **并发支持**：支持多个线程同时读写，内部自动处理锁竞争

---

## 6. 常见问题 (FAQ)

### Q1：数据库文件损坏了怎么办？

**A**：
- SledDB 具有自动恢复能力，轻微损坏可以自动修复
- 如果数据库严重损坏，可以从其他节点重新同步数据
- **建议**：定期备份数据目录，特别是在重要升级前

### Q2：可以更换存储位置吗？

**A**：可以，有两种方式：
1. **软链接**：将新位置软链接到原路径（推荐）
2. **配置修改**：修改节点配置文件中的 `data_dir` 参数

**注意事项**：
- 确保新位置有足够的磁盘空间
- 确保文件系统支持必要的特性（如权限控制）
- 更换位置前需要停止节点

### Q3：数据库文件会一直增长吗？

**A**：是的，随着区块链数据的增长，数据库文件会持续增大。处理方式：
- **状态裁剪**：定期删除旧的账户状态数据（如快照裁剪）
- **数据库压缩**：SledDB 会自动进行空间回收
- **归档策略**：将历史数据迁移到冷存储

### Q4：内存占用会随着数据增长而增加吗？

**A**：不会。norn-storage 使用了智能缓存机制：
- 只缓存"热数据"（近期访问的数据）
- 缓存大小有限（默认 64 个区块），会自动淘汰旧数据
- 即使链上有数百万个区块，内存占用也保持在合理范围

### Q5：可以使用其他数据库吗？

**A**：理论上可以。norn-storage 定义了统一的 `DBInterface` 接口，可以实现基于 RocksDB、LevelDB 等其他数据库的存储后端。但目前只实现了 SledDB 版本。如有需求，可以：
1. 参考 SledDB 实现编写新的数据库适配器
2. 确保 `DBInterface` trait 的所有方法都正确实现
3. 进行充分的测试和性能验证

---

## 技术支持

如有疑问或需要技术支持，请参考项目主文档或联系技术支持团队。

**存储建议**：请使用 SSD 并预留足够的磁盘空间，定期监控磁盘使用情况。
