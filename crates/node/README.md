# norn-node - 节点编排服务模块

## 1. 模块概述 ( Overview)

**norn-node** 是 rust-norn 区块链系统的"网点综合管理系统"，相当于银行的"网点总经理办公室"，负责协调所有部门的工作。如果把整个区块链系统比作一家银行网点，norn-node 就是统筹管理的"总控系统"，协调柜台、金库、账务、安保等各个部门的工作。

这个模块解决了最复杂的**系统集成**问题：区块链系统包含了区块链、交易池、网络、共识、RPC 等多个模块，需要一个"指挥官"来协调它们的工作。norn-node 承担了这个角色，负责模块的初始化、生命周期管理、事件分发、错误处理等。

**核心业务价值**：
- 🎯 **一键启动**：所有模块自动初始化和启动
- 🔄 **自动协调**：各模块间的事件自动分发和处理
- 🛡️ **容错处理**：模块异常时的错误隔离和恢复
- 📊 **状态监控**：实时监控节点运行状态

---

## 2. 核心功能列表 (Key Features)

- **节点初始化**
  - 自动加载配置文件
  - 按依赖顺序初始化所有模块
  - 启动区块链、交易池、共识、网络、RPC 等服务
  - 就像"网点开门"的启动流程，一键开启所有服务

- **事件协调中心**
  - 接收来自网络模块的事件（新区块、新交易、共识消息）
  - 分发事件到对应的处理模块
  - 协调各模块的协同工作
  - 就像"指挥中心"，调度各部门工作

- **区块同步管理**
  - 自动检测本地链的高度
  - 当本地落后时，启动同步流程
  - 从对等节点请求缺失的区块
  - 确保所有节点最终保持一致

- **交易处理流程**
  - 接收来自 RPC 的交易提交请求
  - 转发到交易池进行验证
  - 协调交易的生命周期管理
  - 就像"业务分发中心"，处理客户请求

- **共识参与管理**
  - 初始化共识引擎（PoVF）
  - 配置本地验证者身份
  - 协调 VRF/VDF 计算
  - 参与区块提议和投票

- **Peer 连接管理**
  - 跟踪对等节点的连接状态
  - 维护节点列表和连接统计
  - 处理节点加入和离开事件

- **优雅关闭**
  - 捕获系统信号（如 Ctrl+C）
  - 保存当前状态，确保数据安全
  - 优雅地关闭所有服务
  - 就像"网点关门"的收尾工作

---

## 3. 业务流程/使用场景 (Use Cases)

### 场景一：节点启动流程

**场景描述**：银行网点早上开门，启动所有服务系统。

**业务流程**：
1. **加载配置**
   - 读取配置文件（config.toml）
   - 验证配置合法性
   - 初始化日志系统

2. **启动存储层**
   - 初始化数据库连接
   - 加载或创建创世区块
   - 恢复区块链状态

3. **启动核心服务**
   - 启动区块链引擎
   - 启动交易池
   - 初始化共识引擎

4. **启动网络服务**
   - 初始化 P2P 网络
   - 连接引导节点
   - 加入 P2P 网络

5. **启动 RPC 服务**
   - 启动 gRPC 服务器
   - 监听客户端连接
   - 提供对外服务

6. **启动后台任务**
   - 启动区块生产者
   - 启动同步任务
   - 启动事件循环

**业务价值**：
- 一键启动所有服务，降低运维复杂度
- 自动化的模块初始化，避免人为错误
- 完整的服务编排，确保系统可靠性

### 场景二：交易处理流程

**场景描述**：客户通过网上银行提交一笔转账请求。

**业务流程**：
1. **接收请求**
   - RPC 服务接收客户端的交易提交请求
   - norn-node 转发到交易处理模块

2. **验证交易**
   - 交易池验证交易合法性
   - 检查签名、nonce、余额等
   - 验证通过后加入内存池

3. **返回结果**
   - 向客户端返回交易哈希
   - 交易等待被打包进区块

**业务价值**：
- 提供清晰的交易处理流程
- 各模块职责明确，便于问题排查
- 支持高并发交易处理

### 场景三：节点同步

**场景描述**：网点发现本地账本落后于网络最新状态，需要同步。

**业务流程**：
1. **检测落后**
   - 通过网络模块获取全网最新高度
   - 对比本地高度，发现落后

2. **启动同步**
   - 同步模块向对等节点请求缺失的区块
   - 分批下载区块数据

3. **验证和应用**
   - 验证区块合法性
   - 执行区块中的交易
   - 更新本地区块链状态

4. **同步完成**
   - 达成全网一致状态
   - 开始参与新的共识

**业务价值**：
- 自动检测并修复数据不一致
- 提高系统的容错性
- 确保全网最终一致性

---

## 4. 部署与配置要求 (Deployment & Configuration)

### 环境要求

- **系统资源**：
  - CPU：建议 4 核心及以上
  - 内存：建议 8GB 及以上
  - 磁盘：建议 SSD 100GB 及以上

- **网络要求**：
  - 稳定的网络连接
  - 低延迟的网络环境（共识模块对延迟敏感）

### 关键配置项

```toml
# 数据目录
data_dir = "/var/lib/norn"

# RPC 服务地址
rpc_address = "127.0.0.1:50051"

# 网络配置
[network]
    # P2P 监听地址
    listen_address = "/ip4/0.0.0.0/tcp/4001"

    # 引导节点
    bootstrap_peers = []

    # mDNS 本地发现
    mdns = true

# 共识配置
[core.consensus]
    # 验证者公钥
    pub_key = "020000000000000000000000000000000000000000000000000000000000000000001"

    # 验证者私钥
    prv_key = "0000000000000000000000000000000000000000000000000000000000000000001"

# 区块生产者配置
[core.producer]
    # 是否启用区块生产
    is_validator = true

    # 出块间隔（秒）
    block_interval = 1
```

**配置说明**：
- `data_dir`：数据存储路径
  - 所有链上数据存储在此目录
  - 建议使用高性能磁盘（SSD）
  - 确保磁盘有足够空间

- `rpc_address`：RPC 服务监听地址
  - 对外提供 API 服务的地址和端口
  - 生产环境建议绑定内网 IP 或使用反向代理

- `bootstrap_peers`：引导节点列表
  - 新节点加入网络的"入门地址"
  - 至少配置 1 个引导节点

- `is_validator`：是否启用区块生产
  - 如果只是全节点，设置为 false
  - 如果是验证者节点，设置为 true

### 启动命令

```bash
# 开发模式启动
./target/release/norn --config config.toml

# 后台模式启动
nohup ./target/release/norn --config config.toml > norn.log 2>&1 &

# 查看节点状态
curl http://localhost:50051/grpc.health
```

---

## 5. 接口与集成说明 (API & Integration)

norn-node 是系统的"总控模块"，不直接对外提供 API，而是通过 RPC 模块对外服务。

### 主要管理能力

1. **状态查询**
   ```bash
   # 查看节点高度
   curl http://localhost:50051/norn.Blockchain/GetBlockNumber

   # 查看节点版本
   curl http://localhost:50051/norn.Node/GetVersion
   ```

2. **日志查看**
   ```bash
   # 查看节点日志
   tail -f norn.log

   # 查看特定模块日志
   RUST_LOG=norn_node=debug ./target/release/norn --config config.toml
   ```

3. **优雅关闭**
   ```bash
   # 发送关闭信号
   kill -SIGTERM <pid>

   # 节点会自动保存状态并退出
   ```

### 监控指标

节点会输出多种监控指标，包括：
- 区块生成速度
- 交易处理速度
- 网络连接状态
- 内存使用情况
- 错误和警告信息

---

## 6. 常见问题 (FAQ)

### Q1：如何查看节点是否正常运行？

**A**：
```bash
# 检查进程状态
ps aux | grep norn

# 检查 RPC 服务
curl http://localhost:50051/grpc.health

# 查看日志
tail -f norn.log
```

### Q2：节点启动失败怎么办？

**A**：
1. 检查配置文件语法是否正确
2. 检查端口是否被占用
3. 检查数据目录权限
4. 查看日志文件获取详细错误信息

### Q3：如何配置多节点网络？

**A**：
1. 为每个节点创建独立的配置文件
2. 确保每个节点使用不同的端口（P2P、RPC）
3. 每个节点使用不同的数据目录
4. 配置相同的创世区块（确保在同一链上）
5. 在第一个节点配置中加入引导节点，其他节点配置指向第一个节点

**示例**：
```toml
# 节点1（引导节点）
[network]
    listen_address = "/ip4/0.0.0.0/tcp/4001"
    bootstrap_peers = []
    mdns = true

# 节点2
[network]
    listen_address = "/ip4/0.0.0.0/tcp/4002"
    bootstrap_peers = [
        "/ip4/192.168.1.100/tcp/4001/p2p/..."
    ]
    mdns = false
```

### Q4：如何升级节点版本？

**A**：
1. 停止运行的节点（发送 SIGTERM 信号）
2. 备份数据目录
3. 替换二进制文件
4. 启动新版本节点
5. 观察日志确认升级成功

**注意事项**：
- 不同版本间可能存在数据格式不兼容
- 建议在测试环境验证后再升级生产环境
- 保留回滚方案

### Q5：如何成为验证者节点？

**A**：
1. 生成 VRF 密钥对（使用 `./norn generate-key`）
2. 在配置文件中设置 `is_validator = true`
3. 在共识配置中填入验证者公钥和私钥
4. 确保节点在线时间稳定

**收益**：验证者可以获得区块奖励和交易手续费。

---

## 技术支持

如有疑问或需要技术支持，请参考项目主文档或联系技术支持团队。

**运维提示**：
1. 定期备份数据目录
2. 监控磁盘使用情况
3. 配置日志轮转，避免日志文件过大
4. 生产环境建议配置监控告警
