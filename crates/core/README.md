# norn-core - 区块链核心引擎模块

## 1. 模块概述 (Overview)

**norn-core** 是 rust-norn 区块链系统的"核心业务引擎"，相当于银行的"核心账务系统"。如果把整个区块链系统比作一家银行，norn-core 就是处理存取款、账本维护、交易审核、合规检查的"综合业务系统"。

这个模块实现了区块链的所有核心业务逻辑：从交易验证、区块生成、共识达成、状态管理到费用计算，涵盖了区块链运行的完整流程。

**核心业务价值**：
- 💼 **完整业务逻辑**：实现区块链的所有核心业务功能
- ✅ **交易处理能力**：支持高并发的交易验证和执行
- 🎯 **共识机制集成**：支持 PoVF 共识协议的完整流程
- 💰 **经济模型实现**：实现交易费用计算和区块奖励分配
- 📊 **状态管理**：维护全局世界状态，支持账户余额、nonce 等查询

---

## 2. 核心功能列表 (Key Features)

### 2.1 区块链管理（Blockchain）
- **链式数据结构维护**
  - 管理完整的区块链，每个区块包含前一区块的哈希
  - 支持区块追加、查询、高度管理等操作
  - 就像"账本流水"，每笔账都按顺序记录

- **创世区块初始化**
  - 支持自定义创世区块配置
  - 提供标准化的创世状态初始化
  - 类似于"公司成立时的初始资产分配"

- **数据缓存优化**
  - 内置多级缓存（区块缓存、交易缓存、高度映射）
  - 大幅提升查询性能，减少磁盘 I/O
  - 就像"常用档案放在手边"，快速访问

### 2.2 交易池（Transaction Pool）
- **交易内存池管理**
  - 暂存待打包的交易，支持高并发交易接收
  - 按优先级和费用排序，最大化矿工收益
  - 就像"待处理业务队列"，按重要性排序

- **交易去重与验证**
  - 自动过滤重复交易，防止资源浪费
  - 预先验证交易合法性，提前淘汰不合格交易
  - 就像"业务预审"，提前发现问题

- **Nonce 管理**
  - 跟踪每个账户的交易序列号
  - 防止重复交易和乱序交易
  - 就像"支票编号管理"，防止重复使用

### 2.3 PoVF 共识引擎（Consensus）
- **区块提议（Block Proposal）**
  - 基于 VRF 的公平领导者选举
  - 验证提议者资格和区块合法性
  - 就像"轮流主持股东大会"，公平公开

- **VDF 计算协调**
  - 触发和管理可验证延迟函数计算
  - 验证 VDF 输出，防止时间攻击
  - 就像"沙漏计时"，确保时间公平流逝

- **投票与最终性**
  - 收集验证者投票，达成共识
  - 确定区块的最终性（不可逆）
  - 就像"董事会投票"，一旦通过不可反悔

### 2.4 区块生产者（Block Producer）
- **交易打包**
  - 从交易池选择最优交易组合
  - 考虑 Gas 限制和费用优先级
  - 就像"快递打包"，充分利用空间

- **区块生成**
  - 组装完整的区块数据结构
  - 计算区块哈希和默克尔根
  - 广播到网络

### 2.5 交易执行（Execution）
- **交易验证**
  - 验证签名、nonce、余额等前置条件
  - 确保交易符合业务规则
  - 就像"支票审核"，验证签名和资金

- **状态更新**
  - 执行转账逻辑，更新账户余额
  - 管理 nonce，防止重放攻击
  - 就像"记账处理"，实时更新账户

### 2.6 费用计算（Fee）
- **交易费用计算**
  - 根据交易大小和 Gas 价格计算费用
  - 支持 Gas 限制和动态费用调整
  - 就像"手续费计算"，按使用量收费

- **区块奖励分配**
  - 计算区块奖励（通胀 + 交易费）
  - 支持奖励分配给区块生产者
  - 就像"绩效奖金"，激励矿工工作

### 2.7 默克尔树（Merkle Tree）
- **数据完整性验证**
  - 构建默克尔树，支持快速验证
  - 轻量级证明交易存在性
  - 就像"数据指纹"，确保数据未被篡改

---

## 3. 业务流程/使用场景 (Use Cases)

### 场景一：用户发起交易的完整生命周期

**场景描述**：Alice 向 Bob 转账 100 个代币。

**业务流程**：
1. **交易提交**
   - Alice 的钱包工具创建交易，签名后通过 RPC 接口提交
   - norn-rpc 接收交易，转发给 norn-core 的交易池

2. **交易验证**
   - 交易池验证交易签名、nonce、余额等
   - 验证通过后加入内存池，等待打包

3. **共识选举**
   - PoVF 共识引擎通过 VRF 选举出区块生产者
   - 被选中的节点获得本轮打包权

4. **交易打包**
   - 区块生产者从交易池选择交易
   - 按 Gas 价格和 Gas 限制优化打包策略
   - 将 Alice 的交易和其他交易一起打包成区块

5. **交易执行**
   - 执行引擎验证 Alice 的交易
   - 更新 Alice 和 Bob 的账户余额
   - 扣除 Alice 账户的 Gas 费用

6. **区块上链**
   - 生成的区块通过 norn-network 广播到全网
   - 其他节点验证并接收区块
   - 区块被永久存储到 norn-storage

**业务价值**：
- 实现了完整的交易处理流程
- 确保交易的安全性和不可篡改性
- 提供了清晰的业务流转路径

### 场景二：区块链分叉处理

**场景描述**：网络中同时出现两个竞争区块，需要进行链重组。

**业务流程**：
1. **检测分叉**
   - ReorgHandler 检测到新块与当前链存在分叉
   - 判断是否需要进行链重组

2. **寻找分叉点**
   - 从当前链和新链向后回溯，找到共同的祖先区块
   - 确定需要回滚的区块范围

3. **执行回滚**
   - 将当前链从分叉点之后的区块回滚
   - 撤销这些区块的交易执行结果

4. **应用新链**
   - 验证新链的合法性
   - 执行新链上的交易，更新状态
   - 更新最新链指针

**业务价值**：
- 确保全网最终达成一致
- 维护区块链的单一真实历史
- 提供了灵活的共识容错机制

---

## 4. 部署与配置要求 (Deployment & Configuration)

### 环境要求

- **内存要求**：建议至少 4GB RAM
  - 交易池占用：约 100-500MB（取决于待处理交易数量）
  - 区块缓存：约 50-200MB
  - 状态缓存：约 100-500MB

- **计算资源**：
  - VDF 计算：CPU 密集型，建议多核处理器
  - 交易验证：单线程性能重要，建议高频 CPU

### 关键配置项

```toml
[core]
    # 共识机制配置
    [core.consensus]
    # 验证者公钥列表
    pub_key = "020000000000000000000000000000000000000000000000000000000000000001"

    # 最小 VDF 迭代次数
    min_vdf_iterations = 1000

    # 最大 VDF 迭代次数
    max_vdf_iterations = 10000000

# 区块生产者配置
[core.producer]
    # 是否启用区块生产
    is_validator = true

    # 出块间隔（秒）
    block_interval = 1
```

**配置说明**：
- `pub_key`：验证者的公钥，用于参与共识
- `min_vdf_iterations`：VDF 计算的最小迭代次数，影响出块速度
- `max_vdf_iterations`：VDF 计算的最大迭代次数，防止 DoS 攻击
- `is_validator`：是否启用区块生产（非验证节点设为 false）
- `block_interval`：控制出块频率，影响交易吞吐量

### 性能调优建议

- **交易池大小**：根据内存容量调整交易池容量
- **Gas 限制**：根据网络性能调整区块 Gas 限制
- **缓存大小**：根据查询模式调整缓存容量

---

## 5. 接口与集成说明 (API & Integration)

norn-core 是核心业务逻辑层，不直接对外提供网络接口，而是通过 norn-rpc 和 norn-node 间接对外服务。

### 主要导出能力

1. **区块链管理接口**
   ```rust
   use norn_core::blockchain::Blockchain;

   // 添加区块
   blockchain.add_block(block).await;

   // 查询区块
   let block = blockchain.get_block_by_hash(&hash).await;

   // 获取当前高度
   let height = blockchain.get_block_number().await;
   ```

2. **交易池接口**
   ```rust
   use norn_core::txpool::TxPool;

   // 添加交易
   tx_pool.add_transaction(transaction).await?;

   // 获取待打包交易
   let transactions = tx_pool.get_transactions_for_block().await?;
   ```

3. **共识引擎接口**
   ```rust
   use norn_core::consensus::povf::PoVFEngine;

   // 处理共识消息
   let result = engine.handle_message(message).await?;
   ```

### 数据流示意

```
RPC Request → norn-rpc → norn-core
                    ↓
               (验证/执行)
                    ↓
                norn-storage
```

---

## 6. 常见问题 (FAQ)

### Q1：为什么交易池会有大小限制？

**A**：
- **内存限制**：交易池存储在内存中，无限增长会导致 OOM（内存溢出）
- **性能考虑**：交易池越大，查询和排序越慢
- **业务策略**：限制交易池大小可以鼓励用户提高手续费

**建议**：根据业务需求调整交易池容量，建议设置为 10,000-100,000 笔交易。

### Q2：区块 Gas 限制的作用是什么？

**A**：Gas 限制用于：
- **防止无限循环**：限制单个区块的计算量上限
- **控制出块时间**：确保区块在合理时间内生成
- **网络稳定性**：避免超大区块导致网络拥堵

**调优建议**：根据网络性能和用户需求调整，太低会限制复杂交易，太高会影响出块速度。

### Q3：如何成为验证者节点？

**A**：
1. 生成 VRF 密钥对
2. 将公钥配置到共识模块中
3. 在配置文件中设置 `is_validator = true`
4. 确保节点在线时间达到要求（99.9%+）

**收益**：验证者可以获得区块奖励和交易手续费。

### Q4：共识失败怎么办？

**A**：
- PoVF 共识设计了容错机制，可以容忍部分节点离线
- 只要 2/3 以上的验证者在线，共识可以正常进行
- 如果共识失败，会进入下一轮，重新选举领导者
- **建议**：保持节点在线，维护网络稳定性

### Q5：如何查看交易执行状态？

**A**：
- 通过 RPC 接口查询交易状态
- 交易状态包括：待处理、已打包、已执行、执行失败等
- 可以根据交易哈希查询详细的执行结果

---

## 技术支持

如有疑问或需要技术支持，请参考项目主文档或联系技术支持团队。

**核心提示**：norn-core 是整个系统的业务核心，任何修改都需要充分测试。建议在测试环境验证后再部署到生产环境。
