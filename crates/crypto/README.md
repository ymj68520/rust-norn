# norn-crypto - 密码学安全服务模块

## 1. 模块概述 (Overview)

**norn-crypto** 是 rust-norn 区块链系统的"安全中心"和"信任基石"，提供所有密码学相关的核心功能。如果把区块链比作银行金库，norn-crypto 就是金库的"加密门禁系统"、"防伪印章"和"时间锁保险箱"的综合体。

这个模块解决了区块链系统最核心的**安全问题**：如何在没有中心化信任的情况下，确保交易的真实性、防止数据篡改、保障节点间的共识达成。

**核心业务价值**：
- 🔐 **保障交易安全**：通过数字签名确保只有账户主人才能发起交易
- 🎲 **实现公平选举**：通过可验证随机函数（VRF）实现去中心化的领导者选举
- ⏱️ **防止作弊攻击**：通过可验证延迟函数（VDF）确保网络中的"时间"公平流逝
- 🛡️ **维护数据完整性**：通过哈希算法确保任何数据篡改都能被检测出来

---

## 2. 核心功能列表 (Key Features)

- **VRF（可验证随机函数）服务**
  - 实现基于 P-256 椭圆曲线的随机数生成
  - 提供"随机数 + 证明"机制，任何人都可以验证随机数的生成过程是否公正
  - 应用于共识机制中的领导者选举，确保每个节点都有公平的被选中机会
  - 类似于"可验证的抽签系统"，公开透明且无法作弊

- **VDF（可验证延迟函数）计算器**
  - 实现基于模幂运算的序列计算，确保计算过程必须消耗固定时间
  - 防止攻击者通过提前计算获得时间优势
  - 就像"时间锁保险箱"，即使知道密码，也必须等待足够时间才能打开
  - 用于共识协议中的时间流逝保证

- **ECDSA 数字签名服务**
  - 基于椭圆曲线（secp256k1）的数字签名生成和验证
  - 确保交易的真实性和不可抵赖性
  - 就像银行的"手写签名"验证，但更安全、更难以伪造
  - 支持交易签名、身份认证等多种场景

- **交易验证工具**
  - 提供标准化的交易完整性检查功能
  - 验证交易签名、格式、字段合法性
  - 就像"票据审核员"，在交易进入系统前进行合规性检查

- **哈希计算工具**
  - 基于 SHA-256 的安全哈希计算
  - 生成数据指纹，用于验证数据完整性
  - 应用于区块哈希、默克尔根计算等场景

---

## 3. 业务流程/使用场景 (Use Cases)

### 场景一：共识机制中的领导者选举

**场景描述**：在 PoVF 共识机制中，每个共识轮次需要公平、随机地选举一个领导者来打包区块。

**业务流程**：
1. 共识引擎向 VRF 模块发起"选举请求"，输入当前轮次号
2. VRF 模块使用节点的私钥对轮次号进行签名，生成随机数输出
3. 同时生成"证明材料"，证明该随机数确实由私钥生成
4. 其他节点可以验证：这个随机数是否真的由该节点生成、是否符合选举规则
5. 符合条件的节点成为本轮领导者，获得区块打包权

**业务价值**：
- 确保选举过程公开透明，任何节点都可以验证选举结果
- 防止恶意节点操纵选举结果
- 实现真正的去中心化共识

### 场景二：交易签名与验证

**场景描述**：用户发起一笔转账交易，需要证明这笔交易确实由自己发起。

**业务流程**：
1. 用户的钱包工具使用私钥对交易数据进行 ECDSA 签名
2. 签名后的交易被广播到区块链网络
3. 收到交易的节点调用 norn-crypto 的验证工具
4. 验证工具检查：签名是否合法、格式是否正确、资金是否充足
5. 验证通过后，交易进入内存池等待打包

**业务价值**：
- 防止交易伪造，保护用户资产安全
- 建立跨节点的信任机制，无需中心化背书
- 确保交易的不可抵赖性

---

## 4. 部署与配置要求 (Deployment & Configuration)

### 环境要求

- **硬件要求**：VDF 计算需要一定的 CPU 计算资源
  - 建议使用支持 AES 指令集的现代 CPU
  - 生产环境建议使用 4 核心及以上处理器

- **系统依赖**：无需外部依赖，纯 Rust 实现
  - 避免了 OpenSSL 等第三方库的安全风险
  - 减少了依赖管理和版本冲突问题

### 关键配置项

norn-crypto 模块本身不需要运行时配置，但在使用时需要注意以下参数：

- **VDF 迭代次数**（`MAX_VDF_ITERATIONS`）
  - 默认值：10,000,000 次
  - 作用：控制 VDF 计算的时间成本
  - 调优建议：增加迭代次数可提高安全性，但会延长区块生成时间

- **VRF 密钥管理**
  - 密钥对通常存储在节点的 `node.key` 文件中
  - 生产环境必须妥善保管私钥，建议使用硬件安全模块（HSM）
  - 私钥泄露将导致资产损失，请勿泄露

- **批量计算大小**（`BATCH_SIZE`）
  - 默认值：10,000 次迭代/批次
  - 作用：控制 VDF 计算的批次大小，避免长时间阻塞
  - 调优建议：根据 CPU 性能调整，平衡计算效率和响应速度

---

## 5. 接口与集成说明 (API & Integration)

norn-crypto 是一个**密码学工具库**，不直接对外提供网络接口，而是被其他模块（如 norn-core、norn-node）调用。

### 主要导出能力

1. **VRF 密钥对管理**
   ```rust
   use norn_crypto::vrf::VRFKeyPair;

   // 生成新的密钥对
   let keypair = VRFKeyPair::generate();

   // 导出公钥（用于验证）
   let public_key = keypair.public_key();

   // 进行 VRF 计算和签名
   let output = keypair.evaluate(message);
   ```

2. **交易签名与验证**
   ```rust
   use norn_crypto::transaction::verify_transaction;

   // 验证交易签名
   let is_valid = verify_transaction(&transaction)?;
   ```

3. **VDF 计算**
   ```rust
   use norn_crypto::vdf::SimpleVDF;

   let calculator = SimpleVDF::new();
   let output = calculator.compute_vdf(&input, &params).await?;
   ```

### 性能特性

- **计算性能**：VDF 计算是 CPU 密集型操作，建议在独立的线程池中运行
- **内存占用**：密钥管理占用内存很小，主要是计算过程中的临时数据
- **并发能力**：VRF 签名可以并行处理，VDF 计算通常按顺序执行

---

## 6. 常见问题 (FAQ)

### Q1：为什么需要 VRF 而不是直接使用随机数？

**A**：普通的随机数生成器（RNG）是"不透明"的——无法证明随机数是否真的随机，还是被操纵了。VRF 的核心价值在于**可验证性**：任何人都可以验证这个随机数确实是由私钥持有者生成的，且生成过程符合密码学规则。这就像"现场直播的抽签过程"，而不是"闭门抽签"。

### Q2：VDF 计算会不会很慢？影响系统性能吗？

**A**：VDF 的设计目标就是"慢"，这是安全性的来源，而不是缺陷。但 norn-crypto 实现了多种优化：
- 批量计算：将大计算任务拆分成多个小批次
- 结果缓存：相同输入的计算结果会被缓存
- 异步执行：计算在后台进行，不阻塞主流程

在实际部署中，VDF 计算时间通常设置为几百毫秒到几秒，对系统性能影响可控。

### Q3：密钥丢失后怎么办？

**A**：
- **公钥丢失**：可以从签名或交易中恢复，不影响资产安全
- **私钥丢失**：无法恢复，对应账户的资产将永久无法使用
- **建议**：
  - 生产环境必须做好私钥备份
  - 考虑使用多重签名（Multi-sig）机制分散风险
  - 定期进行备份演练

### Q4：norn-crypto 是否经过了安全审计？

**A**：norn-crypto 使用的密码学算法（如 P-256、secp256k1、SHA-256）都是经过业界广泛验证的标准算法。但作为一个实现，建议：
- 在生产环境部署前进行专业的安全审计
- 关注算法参数配置是否合理
- 监控密钥管理流程是否安全

---

## 技术支持

如有疑问或需要技术支持，请参考项目主文档或联系技术支持团队。

**安全提示**：请妥善保管您的私钥，任何获得私钥的人都能完全控制对应的账户资产。
