# norn-common - 公共基础组件库

## 1. 模块概述 (Overview)

**norn-common** 是 rust-norn 区块链系统的"标准件供应商"，为整个系统提供统一的基础数据类型定义和公共工具函数。如果把整个区块链系统比作一座摩天大楼，norn-common 就是提供标准砖块、水泥和钢筋的建材厂。

这个模块解决了软件开发中最基础的**数据一致性**问题：当不同模块之间需要传递数据时，如果大家各自定义数据格式，就会导致系统混乱不堪。norn-common 统一了所有模块使用的"语言"，确保了系统各部分之间的无缝协作。

**核心业务价值**：
- 🎯 **降低集成成本**：统一的数据定义让模块间对接变得简单直接
- 🎯 **提高开发效率**：开发新功能时无需重复定义基础类型
- 🎯 **保障系统稳定性**：统一的错误处理机制让问题追踪更加高效

---

## 2. 核心功能列表 (Key Features)

- **统一数据类型定义**
  - 定义了区块（Block）、交易（Transaction）、账户地址（Address）、哈希（Hash）等核心业务对象
  - 就像银行系统统一定义"账户"、"交易流水"、"凭证"等概念一样
  - 确保全系统使用相同的数据格式

- **创世区块管理**
  - 提供系统初始状态配置，定义区块链网络的"第一块"
  - 类似于公司章程中的"初始条款"，规定了网络的运行规则
  - 支持灵活的创世参数配置

- **错误处理框架**
  - 提供统一的错误类型定义和错误传播机制
  - 就像银行的"异常处理中心"，规范了错误信息的格式和内容
  - 便于问题追踪和系统监控

- **数据库抽象接口**
  - 定义了统一的键值存储接口，屏蔽底层存储实现细节
  - 类似于"标准化仓储接口"，支持更换不同的存储供应商
  - 提高了系统的可扩展性和可测试性

- **工具函数库**
  - 提供日志记录、配置管理、数据编码等常用工具
  - 就像"办公自动化软件包"，提高开发效率
  - 支持日志分级、配置热加载等高级特性

---

## 3. 业务流程/使用场景 (Use Cases)

### 场景一：新增业务模块需要定义数据格式

**场景描述**：开发团队正在开发一个新的"交易监控模块"，需要查询区块链上的交易数据。

**业务流程**：
1. 开发人员无需重新定义"交易"、"区块"等数据结构
2. 直接从 norn-common 引用统一的 `Transaction`、`Block` 类型
3. 使用标准化的数据字段（如 `timestamp`、`amount`、`from_address` 等）
4. 与其他模块无缝对接，无需编写数据转换代码

**业务价值**：避免数据格式不一致导致的集成问题，减少约 60% 的接口对接工作量。

### 场景二：系统运行时错误追踪

**场景描述**：区块链节点在生产环境运行时突然报错，运维人员需要快速定位问题。

**业务流程**：
1. 系统通过统一的错误处理机制捕获异常
2. 错误信息包含上下文（如哪个模块、哪个操作出错）
3. 错误日志按照统一格式输出，包含时间戳、错误级别、调用堆栈
4. 运维人员通过日志系统快速定位问题根源

**业务价值**：缩短故障排查时间 50% 以上，提高系统可用性。

---

## 4. 部署与配置要求 (Deployment & Configuration)

### 环境要求

- **Rust 版本**：需要 Rust Edition 2021 或更高版本（1.70+）
- **操作系统**：Linux 5.4+ / macOS / Windows（WSL）
- **编译工具**：确保系统已安装 Cargo 包管理器

### 关键配置项

作为基础库，norn-common 本身不需要运行时配置。但在使用时需要注意：

- **创世参数**：在 `genesis.rs` 中配置的创世区块参数会影响整个网络
  - 包括初始验证者集合、预分配资金、网络启动参数等
  - 修改创世配置需要所有节点协调一致，相当于"网络重置"

- **日志级别**：通过 `RUST_LOG` 环境变量控制
  - `export RUST_LOG=info`：常规生产环境
  - `export RUST_LOG=debug`：开发调试环境
  - `export RUST_LOG=norn_common=trace`：深度追踪 common 模块

---

## 5. 接口与集成说明 (API & Integration)

norn-common 是一个**纯代码库**，不提供运行时服务接口。它通过 Rust 的模块系统被其他 crate 引用。

### 主要导出能力

1. **数据类型**（`types.rs`）
   - 导入方式：`use norn_common::types::{Block, Transaction, Hash};`
   - 提供：所有核心业务数据结构的定义

2. **错误类型**（`error.rs`）
   - 导入方式：`use norn_common::error::{Result, NornError};`
   - 提供：统一的错误类型和 Result 别名

3. **数据库接口**（`traits.rs`）
   - 导入方式：`use norn_common::traits::DBInterface;`
   - 提供：可插拔的存储接口定义

4. **创世配置**（`genesis.rs`）
   - 导入方式：`use norn_common::genesis::{get_genesis_block, GENESIS_BLOCK_HASH};`
   - 提供：创世区块和配置参数

### 集成示例

```rust
// 在其他模块中使用 norn-common
use norn_common::types::{Block, Hash};
use norn_common::error::Result;
use norn_common::genesis::get_genesis_block;

async fn process_block(block_hash: &Hash) -> Result<Block> {
    // 业务逻辑
    Ok(Block::default())
}
```

---

## 6. 常见问题 (FAQ)

### Q1：为什么创世区块配置非常重要？

**A**：创世区块相当于区块链网络的"宪法"，定义了网络的初始状态和运行规则。如果不同节点使用不同的创世配置，就像两个国家使用不同的法律，会导致网络无法达成共识，形成"分叉链"。因此，**所有节点必须使用完全相同的创世配置**。

### Q2：修改 norn-common 中的数据类型会影响系统吗？

**A**：会有重大影响。就像修改银行系统的"账户号码"格式一样，修改数据类型会导致：
- 所有依赖该类型的模块需要重新编译
- 已存储的历史数据可能需要迁移
- 与其他版本的节点将无法通信

**建议**：在系统稳定后，避免修改核心数据类型的字段定义。如果必须修改，需要制定详细的迁移方案。

### Q3：如何在生产环境中调试 norn-common 相关的问题？

**A**：
1. **启用详细日志**：设置 `RUST_LOG=norn_common=debug`
2. **使用单元测试**：运行 `cargo test -p norn-common` 验证基础功能
3. **检查版本兼容性**：确保所有模块使用的 norn-common 版本一致

---

## 技术支持

如有疑问，请参考项目主文档或联系技术支持团队。
